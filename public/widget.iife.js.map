{"version":3,"file":"widget.iife.js","sources":["../storefront/src/surveyUI.js","../storefront/src/core/shadow.js","../storefront/src/exitIntent.js","../storefront/src/index.js"],"sourcesContent":["// Creates DOM elements and handles survey UI\n\nconst SURVEY_OPTIONS = [\n  { id: \"price\", label: \"Price is too high\" },\n  { id: \"shipping\", label: \"Shipping is too expensive\" },\n  { id: \"browsing\", label: \"Just browsing\" },\n  { id: \"other\", label: \"Other\" },\n];\n\nexport function renderSurvey(shadowRoot, { onSelect, onClose }) {\n  // Prevent duplicate renders\n  if (shadowRoot.querySelector(\".widget-overlay\")) return;\n\n  const overlay = document.createElement(\"div\");\n  overlay.className = \"widget-overlay\";\n\n  const container = document.createElement(\"div\");\n  container.className = \"widget-container\";\n\n  container.innerHTML = `\n    <button class=\"widget-close\" aria-label=\"Close survey\">&times;</button>\n    <div class=\"widget-header\">\n      <h3 class=\"widget-title\">Quick question before you go...</h3>\n      <p style=\"margin: 8px 0 0; color: #666;\">What stopped you from buying today?</p>\n    </div>\n    <div class=\"widget-options\">\n      ${SURVEY_OPTIONS.map(\n        (opt) => `\n        <button class=\"widget-option\" data-reason=\"${opt.id}\">\n          ${opt.label}\n        </button>\n      `\n      ).join(\"\")}\n    </div>\n  `;\n\n  overlay.appendChild(container);\n  shadowRoot.appendChild(overlay);\n\n  // Trigger animation next frame\n  requestAnimationFrame(() => {\n    overlay.classList.add(\"visible\");\n  });\n\n  // Event Delegation\n  const handleInteraction = (e) => {\n    // Close button\n    if (e.target.closest(\".widget-close\")) {\n      close();\n      return;\n    }\n\n    // Overlay click (background)\n    if (e.target === overlay) {\n      close();\n      return;\n    }\n\n    // Option click\n    const optionBtn = e.target.closest(\".widget-option\");\n    if (optionBtn) {\n      const reason = optionBtn.dataset.reason;\n      close(() => onSelect(reason));\n    }\n  };\n\n  overlay.addEventListener(\"click\", handleInteraction);\n\n  function close(callback) {\n    overlay.classList.remove(\"visible\");\n\n    // Wait for transition to finish before removing\n    overlay.addEventListener(\n      \"transitionend\",\n      () => {\n        overlay.remove();\n        if (callback) callback();\n        else onClose();\n      },\n      { once: true }\n    );\n  }\n}\n","/**\n * Creates a Shadow DOM root attached to the body, ensuring isolation.\n * @param {string} id - Unique ID for the host element\n * @param {string} styles - CSS string to inject\n * @returns {ShadowRoot} The created shadow root\n */\nexport function createShadowRoot(id, styles) {\n  let host = document.getElementById(id);\n\n  if (!host) {\n    host = document.createElement(\"div\");\n    host.id = id;\n    document.body.appendChild(host);\n  }\n\n  // If shadow root exists, return it (idempotent)\n  if (host.shadowRoot) {\n    return host.shadowRoot;\n  }\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n\n  if (styles) {\n    const styleSheet = document.createElement(\"style\");\n    styleSheet.textContent = styles;\n    shadow.appendChild(styleSheet);\n  }\n\n  return shadow;\n}\n\nexport function removeShadowRoot(id) {\n  const host = document.getElementById(id);\n  if (host) {\n    host.remove();\n  }\n}\n","/**\n * Detects exit intent signals appropriately for desktop (mouse) and mobile (scroll/back).\n */\nexport const exitIntent = {\n  /**\n   * Initialize exit intent listeners\n   * @param {Function} callback - Function to call when exit intent is detected\n   * @param {Object} options - Configuration options\n   */\n  init(callback, options = {}) {\n    const {\n      threshold = 10, // pixel distance from top\n      minTimeOnPage = 2000, // don't trigger immediately\n    } = options;\n\n    let armed = false;\n\n    // Arm the trigger after a short delay to prevent false positives on load\n    setTimeout(() => {\n      armed = true;\n    }, minTimeOnPage);\n\n    const checkExit = (e) => {\n      if (!armed) return;\n\n      // Desktop: precise mouse tracking\n      if (e.clientY <= threshold) {\n        callback();\n      }\n    };\n\n    // Use mouseleave on documentElement for better reliability than mouseout\n    document.documentElement.addEventListener(\"mouseleave\", checkExit);\n\n    // Fallback for older browsers\n    document.addEventListener(\"mouseout\", (e) => {\n      if (!e.toElement && !e.relatedTarget) {\n        checkExit(e);\n      }\n    });\n\n    return () => {\n      document.documentElement.removeEventListener(\"mouseleave\", checkExit);\n      document.removeEventListener(\"mouseout\", checkExit);\n    };\n  },\n};\n","import { renderSurvey } from \"./surveyUI.js\";\nimport { createShadowRoot } from \"./core/shadow.js\";\nimport { exitIntent } from \"./exitIntent.js\";\nimport css from \"./styles/widget.css?inline\"; // Vite inline CSS import\n\nconst WIDGET_ID = \"lost-sale-survey-widget\";\n\nclass SurveyWidget {\n  constructor() {\n    if (window.__LOST_SALE_WIDGET_INSTANCE__) {\n      return window.__LOST_SALE_WIDGET_INSTANCE__;\n    }\n\n    this.init();\n    window.__LOST_SALE_WIDGET_INSTANCE__ = this;\n  }\n\n  init() {\n    console.log(\"[SurveyWidget] Initializing...\");\n\n    // Parse configuration from the script tag if needed (future)\n    // const currentScript = document.currentScript;\n    // this.config = { ...currentScript?.dataset };\n\n    // Setup the shadow root early\n    this.shadowRoot = createShadowRoot(WIDGET_ID, css);\n\n    // Placeholder for trigger logic\n    this.setupTriggers();\n  }\n\n  setupTriggers() {\n    // expose public method for manual testing\n    window.LostSale = {\n      open: () => this.showSurvey(),\n    };\n\n    // Initialize exit intent trigger\n    this.cleanupExit = exitIntent.init(() => {\n      console.log(\"[SurveyWidget] Exit intent detected\");\n      this.showSurvey();\n    });\n\n    console.log(\"[SurveyWidget] Initialized with Exit Intent protection.\");\n  }\n\n  showSurvey() {\n    if (this.isOpen) return;\n    this.isOpen = true;\n\n    renderSurvey(this.shadowRoot, {\n      onSelect: (reason) => {\n        console.log(\"[SurveyWidget] Reason selected:\", reason);\n        // TODO: Send to backend\n        this.closeSurvey();\n      },\n      onClose: () => {\n        // Only run close logic if it's currently open\n        this.closeSurvey();\n      },\n    });\n  }\n\n  closeSurvey() {\n    if (!this.isOpen) return;\n    this.isOpen = false;\n    // surveyUI handleClose should effectively remove/hide the UI\n    const overlay = this.shadowRoot.querySelector(\".widget-overlay\");\n    if (overlay) {\n      overlay.dataset.visible = \"false\"; // Signal UI to animate out\n      // Actual DOM removal could be handled by UI layer or here\n    }\n  }\n}\n\n// Auto-initialize\nnew SurveyWidget();\n"],"names":["SURVEY_OPTIONS","renderSurvey","shadowRoot","onSelect","onClose","overlay","container","opt","handleInteraction","e","close","optionBtn","reason","callback","createShadowRoot","id","styles","host","shadow","styleSheet","exitIntent","options","threshold","minTimeOnPage","armed","checkExit","WIDGET_ID","SurveyWidget","css"],"mappings":"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"}